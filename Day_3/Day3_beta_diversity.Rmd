---
title: "Diversity indices"
author: "Vincent Manzanilla, INTERTRYP, IRD"
date: "`r Sys.Date()`"
output: 
  rmdformats::material:
    code_folding: show
    use_bookdown: true
    thumbnails: false
    number_sections: true
    css: "../ETBII.css"
header-includes:
  - \usepackage{subfig}
  - \usepackage{booktabs}
  - \usepackage{xcolor}
editor_options: 
  markdown: 
    wrap: 150
---

```{=html}
<style>

.textbox {
  border: 1px solid #ccc;
  padding: 10px;
  background-color: #f5f5f5;
}

.highlight {
  background-color: yellow;
  font-weight: bold;
}
</style>
```

# Environment

::: textbox
```{r lib}
library(dplyr)
library(tibble)
library(microbiome)
library(vegan)
```


```{r data}
merged_metagenomes <- phyloseq::import_biom("../data/fastq/kraken/bracken//merge_species.biom")
meta <- readxl::read_excel("../data/Glossina_metadata.xlsx")

# Set the new column names in the phyloseq object
sample_names(merged_metagenomes) <- gsub("_.*$|\\.kraken_report_bracken_genuses$", "", sample_names(merged_metagenomes))
sample_names(merged_metagenomes) <- gsub("^Gl", "GI", sample_names(merged_metagenomes))
# Sort the 'meta' data frame by the 'SRA.identifier' column
meta$Sample <- gsub("_.*$", "", meta$Sample)
meta$Samples <- meta$Sample
meta <- meta %>% column_to_rownames(var = "Samples")

# meta$Sample == sample_names(merged_metagenomes)

# Associate the sorted metadata to the phyloseq object as sample data
merged_metagenomes@sam_data <- sample_data(meta)

# Remove the unnecessary 'k_' prefix in the taxonomy data
merged_metagenomes@tax_table@.Data <- substring(merged_metagenomes@tax_table@.Data, 4)

# Rename the columns of the taxonomy table to represent taxonomic ranks
colnames(merged_metagenomes@tax_table@.Data) <- c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")

#Keep only the kingdom of interest
merged_metagenomes <- subset_taxa(merged_metagenomes, Kingdom =="Bacteria")
# head(sample_data(merged_metagenomes))
# head(tax_table(merged_metagenomes))
physeq <- microbiome::aggregate_rare(merged_metagenomes, level = "Genus", detection = 0.01/100, prevalence = 5/100)
# Define the list of samples to remove
samples_to_remove <- c("GI-103", "GI-59", "GI-104", "GI-111", "GI-121", 
                       "GI-124", "GI-125", "GI-14", "GI-15", "GI-16", 
                       "GI-17", "GI-25", "GI-26", "GI-27", "GI-28", 
                       "GI-29", "GI-30", "GI-31", "GI-32", "GI-33", 
                       "GI-34", "GI-36", "GI-38", "GI-39", "GI-45", "GI-47", "GI-51", "I9", "I7")

# Prune these samples from your phyloseq object
physeq <- prune_samples(!(sample_names(physeq) %in% samples_to_remove), physeq)


tax_table_df <- as.data.frame(physeq@tax_table)
otus_to_keep <- rownames(tax_table_df[tax_table_df$Genus != "Other", ])
physeq <- prune_taxa(otus_to_keep, physeq)

```
:::



### sanity check

```{r, eval=FALSE}
# Identify OTUs with zero counts
empty_otus <- taxa_names(physeq)[taxa_sums(physeq) == 0]

# Print the empty OTU names
if (length(empty_otus) > 0) {
  print(paste("Empty OTUs:", paste(empty_otus, collapse = ", ")))
} else {
  print("No empty OTUs.")
}

# Identify samples with zero counts
empty_samples <- sample_names(physeq)[sample_sums(physeq) == 0]

# Print the empty sample names
if (length(empty_samples) > 0) {
    print(paste("Empty samples:", paste(empty_samples, collapse = ", ")))
} else {
    print("No empty samples.")
}
```


```{r}
# # Remove samples with no counts
# physeq_F <- prune_samples(sample_sums(physeq) > 0, physeq)
# # Remove OTUs with no counts
physeq <- prune_taxa(taxa_sums(physeq) > 0, physeq)
pseq <- physeq
```


::: textbox
# Data Normalization

Data transformations are common in (microbial) ecology (Legendre 2001) and used to improve compatibility with assumptions related to specific statistical methods, mitigate biases, enhance the comparability of samples or features, or to obtain more interpretable values.

Examples include the logarithmic transformation, calculation of relative abundances (percentages), and compositionality-aware transformations such as the centered log-ratio transformation (clr).

Let us summarize some commonly used transformations in microbiome data science; further details and benchmarkings available in the references:

- *relabundance* relative transformation; also known as total sum scaling (TSS) and compositional transformation. This converts counts into percentages (at the scale [0, 1]) that sum up to. Much of the currently available taxonomic abundance data from high-throughput assays (16S, metagenomic sequencing) is compositional by nature, even if the data is provided as counts (Gloor et al. 2017).

- *clr* Centered log ratio transformation (Aitchison 1986) is used to reduce data skewness and compositionality bias in relative abundances, while bringing the data to the logarithmic scale. This transformation is frequently applied in microbial ecology (Gloor et al. 2017). However, this transformation only applies to positive values. Usual solution is to add pseudocount, which adds another type of bias in the data. The robust clr transformation (‘rclr’) aims to circumvent the need to add a pseudocount. While the resulting values from these transformations are difficult interpret directly, this transformation may enhance comparability of relative differences between samples. It is part of a broader Aitchison family of transformations; the additive log ratio transformation (`alr’) is also available. The robust clr (“rclr”) is similar to regular clr (see above) but allows data with zeroes and avoids the need to add pseudocount Martino et al. (2019). See library *compositions*. 

- *pa* presence/absence transformation ignores abundances and only indicates whether the given feature is detected above the given threshold (default: 0). This simple transformation is relatively widely used in ecological research. It has shown good performance in microbiome-based classification performance (Giliberti et al. 2022, Karwowska2024).

- *z* Z transformation scales data to zero mean and unit variance; this us used to bring features (or samples) to more comparable levels in terms of mean and scale of the values. This can enhance visualization and interpretation of the data

- *log*, *log2*, *log10* Logarithmic transformations; used e.g. to reduce data skewness; with compositional data the clr (or rclr) transformation is often preferred.

- *hellinger* Hellinger transformation equals to the square root of relative abundances. This ecological transformation can be useful if we are interested in changes in relative abundances.

- *rank* Rank transformation replaces each value by its rank. Also see ‘rrank’ (relative rank transformation). This has use for instance in non-parametric statistics.

- Other available transformations include Chi square (‘chi.square’), Frequency transformation (‘frequency’), and Make margin sum of squares equal to one (‘normalize’)


The data contains read counts. We can convert these into relative abundances and other formats. Compare abundance of a given taxonomic group using the example data before and after the compositionality transformation (with a cross-plot, for instance). You can also compare the results to CLR-transformed data (see e.g. Gloor et al. 2017)

Have a look at the function *?microbiome::transform*.


```{r trans1}

pseq <- physeq
set.seed(34521)

# Read count
# Calculate distance matrix
pseq_comp <- vegdist(t(pseq@otu_table), method = "bray")
# Perform NMDS on distance matrix
nmds_spec <- vegan::metaMDS(pseq_comp, distance = "bray", k = 2)
# Extract and reshape the data to plot ordination as ggplot  and add the metadata
# Convert the NMDS points to a data frame
nmds_spec_gg <- as.data.frame(nmds_spec$points)
# Add the "Sample" column based on row names
nmds_spec_gg <- nmds_spec_gg %>% rownames_to_column("Sample")
# Merge the NMDS data with the metadata by the "Sample" column
sample_data_df <- as.data.frame(as(physeq@sam_data, "data.frame"))
merged_data <- dplyr::left_join(sample_data_df, nmds_spec_gg, by = "Sample")
plt_read <- ggplot(merged_data, aes(x = MDS1, y = MDS2)) +
  geom_point(aes(color = Ecological.gradient), size = 3, alpha = 0.5) +
  geom_text_repel(aes(label = Sample), size = 3, color = "black", max.overlaps = 50) +
  ggtitle("Read count") +
  theme_minimal()
plt_read
```

```{r trans2}
# abundances
pseq_comp <- microbiome::transform(pseq, transform = "compositional")
pseq_comp  <- abundances(pseq_comp) %>% as.data.frame()  
pseq_comp <- pseq_comp[order(rowSums(pseq_comp), decreasing = TRUE), ] %>% t()
# Calculate distance matrix
pseq_comp <- vegdist(pseq_comp, method = "bray")
# Perform NMDS on distance matrix
nmds_spec <- metaMDS(pseq_comp, distance = "bray",k = 2)
# Extract and reshape the data to plot ordination as ggplot  and add the metadata
# Convert the NMDS points to a data frame
nmds_spec_gg <- as.data.frame(nmds_spec$points)
# Add the "Sample" column based on row names
nmds_spec_gg <- nmds_spec_gg %>% rownames_to_column("Sample")
# Merge the NMDS data with the metadata by the "Sample" column
sample_data_df <- as.data.frame(as(physeq@sam_data, "data.frame"))
merged_data <- dplyr::left_join(sample_data_df, nmds_spec_gg, by = "Sample")
plt_comp <- ggplot(merged_data, aes(x = MDS1, y = MDS2)) +
  geom_point(aes(color = Ecological.gradient), size = 3, alpha = 0.5) +
  geom_text_repel(aes(label = Sample), size = 3, color = "black", max.overlaps = 50) +
  ggtitle("Compositional") +
  theme_minimal()
plt_comp
```

```{r trans3}
# clr
pseq_clr <- microbiome::transform(pseq, transform = "clr")
pseq_clr  <- abundances(pseq_clr) %>% as.data.frame()  
pseq_clr <- pseq_clr[order(rowSums(pseq_clr), decreasing = TRUE), ] %>% t()
# Calculate distance matrix
pseq_clr <- vegdist(pseq_clr, method = "euclidian")
# Perform NMDS on distance matrix
nmds_spec <- metaMDS(pseq_clr, distance = "bray",k = 2)
# Extract and reshape the data to plot ordination as ggplot  and add the metadata
# Convert the NMDS points to a data frame
nmds_spec_gg <- as.data.frame(nmds_spec$points)
# Add the "Sample" column based on row names
nmds_spec_gg <- nmds_spec_gg %>% rownames_to_column("Sample")
# Merge the NMDS data with the metadata by the "Sample" column
sample_data_df <- as.data.frame(as(physeq@sam_data, "data.frame"))
merged_data <- dplyr::left_join(sample_data_df, nmds_spec_gg, by = "Sample")
plt_clr <- ggplot(merged_data, aes(x = MDS1, y = MDS2)) +
  geom_point(aes(color = Ecological.gradient), size = 3, alpha = 0.5) +
  geom_text_repel(aes(label = Sample), size = 3, color = "black", max.overlaps = 50) +
  ggtitle("CLR") +
  theme_minimal()
plt_clr
```

```{r trans4}
# Z
pseq_z <- microbiome::transform(pseq, transform = "Z")
pseq_z  <- abundances(pseq_z) %>% as.data.frame()  
pseq_z <- pseq_z[order(rowSums(pseq_z), decreasing = TRUE), ] %>% t()
# Calculate distance matrix
pseq_clr <- vegdist(pseq_z, method = "euclidian")
# Perform NMDS on distance matrix
nmds_spec <- metaMDS(pseq_clr, distance = "bray",k = 2)
# Extract and reshape the data to plot ordination as ggplot  and add the metadata
# Convert the NMDS points to a data frame
nmds_spec_gg <- as.data.frame(nmds_spec$points)
# Add the "Sample" column based on row names
nmds_spec_gg <- nmds_spec_gg %>% rownames_to_column("Sample")
# Merge the NMDS data with the metadata by the "Sample" column
sample_data_df <- as.data.frame(as(physeq@sam_data, "data.frame"))
merged_data <- dplyr::left_join(sample_data_df, nmds_spec_gg, by = "Sample")
plt_z <- ggplot(merged_data, aes(x = MDS1, y = MDS2)) +
  geom_point(aes(color = Ecological.gradient), size = 3, alpha = 0.5) +
  geom_text_repel(aes(label = Sample), size = 3, color = "black", max.overlaps = 50) +
  ggtitle("Z") +
  theme_minimal()
plt_z
```



**Q: Which normalization is the best?**

:::

# 2 Beta diversity

Beta diversity quantifies the dissimilarity between communities (multiple samples), as opposed to alpha diversity which focuses on variation within a community (one sample). In microbiome research, commonly used metrics of beta diversity include the Bray-Curtis index (for compositional data), Jaccard index (for presence/absence data, ignoring abundance information), Aitchison distance (Euclidean distance for clr transformed abundances, aiming to avoid the compositionality bias), and the Unifrac distance (that takes into account the phylogenetic tree information). Notably, only some of these measures are actual distances, as this is a mathematical concept whose definition is not satisfied by certain ecological measure, such as the Bray-Curtis index. Therefore, the terms dissimilarity and beta diversity are preferred.

| Method description             | Assay type          | Beta diversity metric |
|--------------------------------|---------------------|-----------------------|
| Quantitative profiling         | Absolute counts     | Bray-Curtis           |
| Relative profiling             | Relative abundances | Bray-Curtis           |
| Aitchison distance             | Absolute counts     | **Aitchison**             |
| Aitchison distance             | clr                 | Euclidean             |
| Robust Aitchison distance      | rclr                | Euclidean             |
| Presence/Absence similarity    | Relative abundances | **Jaccard**               |
| Presence/Absence similarity    | Absolute counts     | **Jaccard**               |
| Phylogenetic distance          | Rarefied counts     | Unifrac               |

In practice, beta diversity is usually represented as a *dist* object, a triangular matrix where the distance between each pair of samples is encoded by a specific cell. This distance matrix can then undergo ordination, which is an important ecological tool to reduce the dimensionality of data for a more efficient analysis and visualization. Ordination techniques aim to capture as much essential information from the data as possible and turn it into a lower dimensional representation. Dimension reduction is bound to lose information but commonly used ordination techniques can preserve relevant information of sample similarities in an optimal way, which is defined in different ways by different methods.

Based on the type of algorithm, ordination methods in microbiome research can be generally divided in two categories: unsupervised and supervised ordination. The former includes Principal Coordinate Analysis (PCoA), Principal Component Analysis (PCA) and Uniform Manifold Approximation and Projection for Dimension Reduction (UMAP), whereas the latter is mainly represented by distance-based Redundancy Analysis (dbRDA). We will first discuss unsupervised ordination methods and then proceed to supervised ones.


### 2.1 Unsupervised ordination

Unsupervised ordination methods variation in the data without additional information on covariates or other supervision of the model. Among the different approaches, Multi-Dimensional Scaling (MDS) and non-metric MDS (NMDS) can be regarded as the standard. They are jointly referred to as PCoA. 

A typical comparison of community compositions starts with a visual representation of the groups by a 2D ordination. Then we estimate relative abundances and MDS ordination based on Bray-Curtis index between the groups, and visualize the results.

```{r unsup}
# To ensure reproducibility we can fix the seed here. This will ensure you always get the same result each time you run your data.
set.seed(34521)
pseq_clr <- microbiome::transform(pseq, transform = "clr")

species_frac_filtered_dist <- vegdist(t(pseq_clr@otu_table), method = "euclidean")
# Perform NMDS on distance matrix
nmds_spec <- metaMDS(species_frac_filtered_dist, distance = "euclidean",k = 2)
```

Check the output. 

```{r check}
# Check the output
nmds_spec
```
Here you see a kind of summary of the analysis. For example, you can see that you used 2 dimensions and the stress was approx. 0.03. In general if a stress is above 0.2 then the clustering is not reliably representing the data and should be interpreted with caution. But here the stress is below 0.2, so we are okay.

Now let’s look at the ordination. To plot the data with ggplot, we need to extract the coordinaties of each point from nmds_spec$points.

```{r extract}
# Extract and reshape the data to plot ordination as ggplot  and add the metadata
# Convert the NMDS points to a data frame
nmds_spec_gg <- as.data.frame(nmds_spec$points)

# Add the "Sample" column based on row names
nmds_spec_gg <- nmds_spec_gg %>% rownames_to_column("Sample")

# Merge the NMDS data with the metadata by the "Sample" column
sample_data_df <- as.data.frame(as(physeq@sam_data, "data.frame"))
merged_data <- dplyr::left_join(sample_data_df, nmds_spec_gg, by = "Sample")
```
Then we can create the plot easily and color according to the metadata. We are choosing timepoint and mocktreat for the coloring respectively. But feel free to explore other parameters.


```{r plot6, eval=T}
ggplot(merged_data, aes(x = MDS1, y = MDS2)) +
    geom_point(aes(color = Ecological.gradient), size = 3, alpha = 0.5) +
    geom_text_repel(aes(label = infection), size = 3, color = "black") +
    ggtitle("NMDS colored according to Reads numbers") +
    theme_minimal()
```

A few combinations of beta diversity metrics and assay types are typically used. For instance, Bray-Curtis dissimilarity and Euclidean distance are often applied to the relative abundance and the clr assays, respectively. Besides beta diversity metric and assay type, the PCoA algorithm is also a variable that should be considered. Below, we show how the choice of these three factors can affect the resulting lower-dimensional data.



```{r nmds, eval=FALSE}

# abundances(pseq)
pseq <- pseq_clr
pseq_abund  <- abundances(pseq) %>% as.data.frame() 
pseq_abund <- pseq_abund[order(rowSums(pseq_abund), decreasing = TRUE), ] %>% t()
# Calculate distance matrix
species_frac_filtered_dist_bray <- vegdist(pseq_abund, method = "bray")
# Perform NMDS on distance matrix
nmds_spec_comp_bray <- metaMDS(species_frac_filtered_dist_bray,distance = "bray",k = 2)

# Run NMDS on compositional assay with Euclidean distances
# Calculate distance matrix
species_frac_filtered_dist_euclidean <- vegdist(pseq_abund, method = "euclidean")
# Perform NMDS on distance matrix
nmds_spec_comp_euclidean <- metaMDS(species_frac_filtered_dist_euclidean,distance = "euclidean",k = 2)

# Run NMDS on compositional assay with Aitchison distances
# Calculate distance matrix
species_frac_filtered_dist_aitchison <- vegdist(pseq_abund, method = "robust.aitchison")
# Perform NMDS on distance matrix
nmds_spec_comp_aitchison <- metaMDS(species_frac_filtered_dist_aitchison,distance = "robust.aitchison",k = 2)

# Run NMDS on clr assay with Euclidean distances
pseq <- aggregate_rare(merged_metagenomes, level = "Genus", detection = 0.1/100, prevalence = 50/100)
pseq <- microbiome::transform(pseq, transform = "clr")
pseq  <- abundances(pseq) %>% as.data.frame() 
pseq <- pseq <- pseq[order(rowSums(pseq), decreasing = TRUE), ] %>% t()
# Calculate distance matrix
species_frac_filtered_dist_euclidean <- vegdist(pseq, method = "euclidean")
# Perform NMDS on distance matrix
nmds_spec_clr_euclidean <- metaMDS(species_frac_filtered_dist_euclidean,distance = "euclidean",k = 2)

# List of NMDS objects and their corresponding titles
nmds_list <- list(
  list(data = nmds_spec_comp_bray, title = "Comp Bray"),
  list(data = nmds_spec_comp_euclidean, title = "Comp Euclidean"),
  list(data = nmds_spec_comp_aitchison, title = "Comp Aitchison"),
  list(data = nmds_spec_clr_euclidean, title = "Clr Euclidean")
)

# Initialize an empty list to store plots
plot_list <- list()

# Loop through each NMDS object and generate the corresponding plot
for (nmds_item in nmds_list) {
  nmds_spec_gg <- as.data.frame(nmds_item$data$points) %>%
    rownames_to_column("Sample") %>%
    dplyr::left_join(meta, by = "Sample")
  
  plot1 <- ggplot(nmds_spec_gg, aes(x = MDS1, y = MDS2)) +
    geom_point(aes(color = `Ecological gradient`), size = 3, alpha = 0.5) +
    geom_text_repel(aes(label = Sample), size = 3, color = "black") +
    ggtitle(paste("NMDS colored according to Ecological gradient", nmds_item$title)) +
    theme_minimal()
  
  # Add the plot to the plot list
  plot_list[[nmds_item$title]] <- plot1
}

# Combine all plots using patchwork
combined_plot <- wrap_plots(plot_list) +
  plot_layout(guides = "collect")

# Print the combined plot
print(combined_plot)
```

In the Shepard plot, a narrow scatter around a 1:1 line indicates a good fit of the distances to the dissimilarities, while a large scatter or a nonlinear pattern indicates a lack of fit.

```{r stress}
stressplot(nmds_spec)
```

### 2.2 Supervised ordination

dbRDA is a supervised counterpart of PCoA. It maximize the variance with respect to the covariates provided by the user. This can be used to quantify associations between each covariate and community composition (beta diversity). The table below summarizes the relations between the supervised and unsupervised ordination methods.

| Supervised ordination  | Unsupervised ordination          |
|------------------------|----------------------------------|
| Euclidean distance     | RDA                              | PCA                         |
| Non-Euclidean distance | dbRDA                            | PCoA/MDS, NMDS, UMAP        |


In summary, the dbRDA is the more general method that allows a wider variety dissimilarity, or beta diversity, indices. 

We are using the package mia for this analysis, fist we transform our phyloseq object into a mia compatible object. The colData lists the covariates such as Gut and Type...

```{r mia}
pseq_mia <-  mia::makeTreeSummarizedExperimentFromPhyloseq(pseq)

# Apply relative transform
pseq_mia <- mia::transformAssay(pseq_mia , method = "hellinger")
```

dbRDA can be performed with the runRDA function. In addition to the arguments previously defined for unsupervised ordination, this function takes a formula to control for variables and an action to treat missing values. Along with metadata, which is the main outcome,we can treat observations missing values (not the case here). 

```{r mia1}
pseq_RDA <- mia::runRDA(pseq_mia,
               assay.type = "hellinger",
               formula = assay ~ sex + infection + Ecological.gradient,
               distance = "euclidian",
               na.action = na.exclude)
```

The importance of each variable on the similarity between samples can be assessed from the results of PERMANOVA, automatically provided by the runRDA function. We see that Time explain more than 42% of the variance and it is also significant.

```{r rda}
# Store results of PERMANOVA test
rda_info <- attr(reducedDim(pseq_RDA, "RDA"), "significance")
rda_info$permanova
```

Next, we proceed to visualize the weight and significance of each variable on the similarity between samples with an RDA plot, which can be generated with the plotRDA function from the miaViz package.

```{r plot7, eval=T}
# Load packages for plotting function
library(miaViz)

# Generate RDA plot coloured by clinical status"
plotRDA(pseq_RDA, "RDA", colour_by = "Ecological.gradient")
```

Arrow length is proportional to the degree of correlation between the environmental variable and the ordination



### Estimating associations with an external variable

Next to visualizing whether any variable is associated with differences between samples, we can also quantify the strength of the association between community composition (beta diversity) and external factors.

Permutational Analysis of Variance (PERMANOVA; (2001)) is a widely used non-parametric multivariate method that aims to estimate the actual statistical significance of differences in the observed community composition between two groups of samples. This method takes as input the abundance table, which measure of distance you want to base the test on and a formula that tells the model how you think the variables are associated with each other.

PERMANOVA tests the hypothesis that the centroids and dispersion of the community are equivalent between the compared groups. A p-value smaller than the significance threshold indicates that the groups have a different community composition. This method is implemented with the adonis2 function from the vegan package.

```{r otu, eval=T}

otu <- abundances(pseq_clr)
meta <- meta(pseq_clr)

#head(otu)
#head(meta)

permanova <- adonis2(t(otu) ~ Ecological.gradient ,
                    by = "margin",
                    data = meta, 
                    permutations = 9999, 
                    method = "euclidian")
```

P-value: 

```{r pval1}
permanova
```

The time variable is significantly associated with microbiota composition (p-value is below 0.05).

Let us visualize the model coefficients for species that exhibit the largest differences between the groups. This gives some insights into how the groups tend to differ from each other in terms of community composition.


```{r coef}

# pseq_clr <- microbiome::transform(pseq, transform = "clr")


# Perform dbRDA
dbrda <- dbrda(t(otu) ~ Ecological.gradient, 
               data = meta)
sppscores(dbrda) <-t(otu)
coef <- as.data.frame(dbrda$CCA$v) %>% select(dbRDA1)

# Sort by the values of the coefficients
sorted_coef <- coef[order((coef$dbRDA1), decreasing = TRUE), , drop = FALSE]

# Select the top 10 highest and 10 lowest absolute values
top_10_coef <- head(sorted_coef, 10)
bottom_10_coef <- tail(sorted_coef, 10)

# Combine them into one data frame
top_and_bottom_coef <- rbind(top_10_coef, bottom_10_coef)

# Display the result

top_names <- rownames(top_and_bottom_coef)
top.coef <- top_and_bottom_coef$dbRDA1

df <- data.frame(x = top.coef,
                 y = factor((top_names), unique((top_names))))

p <- ggplot(df, aes(x = x, y = y)) +
  geom_bar(stat = "identity") +
  labs(x = "", y= "", title = "Top Taxa") +
  theme_bw()

p
```


**Wigglesworthia**
Vertically Transmitted
Endosymbiont of tsetse flies.
Wigglesworthia synthesizes key B-complex vitamins that the fly does not get from its diet of blood. Without the vitamins Wigglesworthia produces, the tsetse fly has greatly reduced growth and reproduction. Since the tsetse fly is the primary vector of Trypanosoma brucei, the pathogen that causes African trypanosomiasis, it has been suggested that W. glossinidia may one day be used to help control the spread of this disease.

**Buchnera**
Vertically Transmitted
Endosymbiont
Buchnera aphidicola is a well-known symbiont of aphids. It resides in specialized cells called bacteriocytes and provides essential amino acids that the aphid diet (plant phloem) lacks. This mutualistic relationship is essential for the survival of aphids.

**Arsenophonus**
Vertically Transmitted
Endosymbiont
Role: Arsenophonus is a facultative symbiont found in many insects. In some species, it affects reproductive biology by manipulating host sex ratios (e.g., through male-killing mechanisms), while in others, it provides metabolic benefits, like nutrient provisioning.
Is it the same system as wolbachia? 

**Halomonas**
environmental bacteria
In gut or environmental microbiomes, Halomonas can participate in breaking down organic materials and is involved in nitrogen and sulfur cycles, which could contribute to gut health or host metabolism in saline or stressful environments.

**Candidatus Curculioniphilus**
Vertically Transmitted
Endosymbiont
Role: This is an intracellular bacterium found in weevils (a type of beetle). Like other symbionts, it contributes to nutrient synthesis or detoxification, which helps the insect thrive on its diet of plant material.

**Candidatus Baumannia**
Vertically Transmitted
Endosymbiont
Candidatus Baumannia is a symbiont of the glassy-winged sharpshooter and resides in its bacteriocytes. Like Buchnera, it provides essential nutrients to the host, particularly vitamins and cofactors that are missing from the host's plant diet.Candidatus Baumannia is part of a microbiome where it helps fill nutritional gaps in the diet of hosts, often in combination with other symbionts, thus contributing to host health.

**Candidatus Ishikawaella**
Vertically Transmitted
Endosymbiont
Role: This symbiont is found in plataspid stinkbugs and provides essential amino acids, similar to Buchnera in aphids. It helps the stinkbugs survive on a plant sap diet that lacks certain nutrients. In microbiomes, Candidatus Ishikawaella plays a role in ensuring nutritional balance in hosts with specialized diets.

**Turicibacter**
Turicibacter is a genus found in the gut microbiome of mammals, including humans. It is often associated with the immune system and gut health, and its presence has been correlated with the modulation of inflammation and immune response. In gut microbiomes, Turicibacter may be involved in regulating host immune responses, contributing to gut homeostasis, and influencing metabolic health.

**Corynebacterium**
environmental bacteria
Corynebacterium is a genus found in various environments, including skin, gut, and urogenital tracts of humans and animals. It is involved in normal microbial flora but can also be opportunistic pathogens in some cases. Certain species can break down complex lipids and contribute to maintaining the balance in microbiomes.  In microbiomes, Corynebacterium plays a role in skin and gut health, helping maintain the balance between beneficial and harmful microbes. In some cases, it might also have roles in pathogenicity if the balance is disrupted.

**Streptococcus**
Found in the gut and mucous membranes of various animals, including humans and insects. In some cases, they can be opportunistic pathogens.

**Enterococcus**
Commonly found in the intestines of humans and animals. Enterococci are part of the normal gut flora but can also cause infections if they enter sterile body parts.

**Acinetobacter**
Widely distributed in soil, water, and living organisms. It can be part of the skin or gut microbiome and is also known for its antibiotic resistance.

**Geobacillus**
A thermophilic bacterium found in soil, hot springs, and other extreme environments. Not typically found as part of a tsetse fly microbiome.

**Lactobacillus**
Commonly found in the gut and reproductive tracts of many animals. Known for producing lactic acid and contributing to the maintenance of gut health.

**Anoxybacillus**
Found in thermophilic environments.
 
**Lysinibacillus**
Found in soil and water, it can produce toxins and has been used in biocontrol efforts against pests.
 
 **Staphylococcus**
Found on skin and mucous membranes of animals, including humans and insects. Some species are opportunistic pathogens.
 
**Paenibacillus**
Known for nitrogen fixation and its presence in soil. It can produce antibiotics and is associated with plant and insect microbiomes.

**Bacillus**
Commonly found in soil and environmental microbiomes. Some species, such as Bacillus thuringiensis, are used in biocontrol. Bacillus species are known for their spore-forming abilities, which help them survive in extreme environments.




**Exercises** 

Community-level comparisons: Use PERMANOVA to investigate whether the community composition differs between two groups of individuals (e.g. times, or some other grouping of your choice). You can also include covariates such as type, gut, and see how this affects the results?


### Confounding effects

Confounders can be defined as variables that are related to and affect the apparent dynamics between the response and the main independent variable. They are common in experimental studies. Generally, they can be classified into 3 groups:

- Biological confounders, such as age and sex

- Technical confounders produced during sample collection, processing and analysis

- Confounders resulting from experimental models, such as batch effects and sample history

Controlling for confounders is an important practice to reach an unbiased conclusion. To perform causal inference, it is crucial that the method is able to include confounders in the model. This is not possible with statistical tests of general use, such as the Wilcoxon test.

**Exercises** 
Try to see if the number of reads have an effect on the results? 




# Exploration of the communities

```{r}

pseq <- physeq
set.seed(34521)

# Read count
# Calculate distance matrix
pseq_comp <- vegdist((pseq@otu_table), method = "bray")
# Perform NMDS on distance matrix
nmds_spec <- vegan::metaMDS(pseq_comp, distance = "bray", k = 2)
# Extract and reshape the data to plot ordination as ggplot  and add the metadata
# Convert the NMDS points to a data frame
nmds_spec_gg <- as.data.frame(nmds_spec$points)
# Add the "Sample" column based on row names
nmds_spec_gg <- nmds_spec_gg %>% rownames_to_column("Sample")
# # Merge the NMDS data with the metadata by the "Sample" column
# sample_data_df <- as.data.frame(as(physeq@sam_data, "data.frame"))
# merged_data <- dplyr::left_join(sample_data_df, nmds_spec_gg, by = "Sample")
plt_read <- ggplot(nmds_spec_gg, aes(x = MDS1, y = MDS2)) +
  geom_point(color = "blue", size = 2) +
  geom_text_repel(aes(label = Sample), size = 3, color = "black", max.overlaps = 50) +
  ggtitle("Bateria clustering - read count") +
  theme_minimal()
plt_read
```

```{r}
pseq <- physeq
set.seed(34521)
pseq_clr <- microbiome::transform(pseq, transform = "clr")

# Read count
# Calculate distance matrix
pseq_comp <- vegdist((pseq_clr@otu_table), method = "bray")
# Perform NMDS on distance matrix
nmds_spec <- vegan::metaMDS(pseq_comp, distance = "bray", k = 2)
# Extract and reshape the data to plot ordination as ggplot  and add the metadata
# Convert the NMDS points to a data frame
nmds_spec_gg <- as.data.frame(nmds_spec$points)
# Add the "Sample" column based on row names
nmds_spec_gg <- nmds_spec_gg %>% rownames_to_column("Sample")
# # Merge the NMDS data with the metadata by the "Sample" column
# sample_data_df <- as.data.frame(as(physeq@sam_data, "data.frame"))
# merged_data <- dplyr::left_join(sample_data_df, nmds_spec_gg, by = "Sample")
plt_read <- ggplot(nmds_spec_gg, aes(x = MDS1, y = MDS2)) +
  geom_point(color = "blue", size = 2) +
  geom_text_repel(aes(label = Sample), size = 3, color = "black", max.overlaps = 50) +
  ggtitle("Bateria clustering - clr normalized") +
  theme_minimal()
plt_read
```


